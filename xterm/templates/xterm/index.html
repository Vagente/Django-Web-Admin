<!doctype html>
<html style="height: calc(100% - 50px)" lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <title>xterm</title>
</head>

<body style="height: 100%; background: #0d0d0d">

<div style="background: #0d0d0d; padding-bottom: 5px;">
    <span style="font-size: small; color: white">Status: <span style="font-size: small;"
                                                               id="status">connecting...</span></span>
    <button id="button" type="button" onclick="connection_button()">Connect</button>
</div>

<div style=" width: 100%; height:100%;" id="terminal"></div>

<script>
    const terminal = new Terminal({
        theme: {
            background: '#171717',
        },
        cursorBlink: true
    });
    const fitAddon = new FitAddon.FitAddon();
    terminal.loadAddon(fitAddon);

    const socket = new WebSocket(
        'wss://localhost/ws/xterm/'
    )

    const status = document.getElementById("status")
    const button = document.getElementById("button")

    terminal.open(document.getElementById('terminal'));

    terminal.onKey(event => {
        socket.send(JSON.stringify({
            "type": "pty_input",
            "content": event["key"]
        }));
    });

    socket.onopen = function () {
        status.innerHTML = '<span style="background-color: green;">connected</span>'
        button.innerHTML = 'Disconnect'
    }

    socket.onclose = function (event) {
        status.innerHTML = '<span style="background-color: red;">disconnected</span>'
        button.innerHTML = 'Connect'
        if (event["code"] === {{ CONNECTION_LIMIT_CODE }}){
            alert({{ MAX_CONNECTION }} + " max connection limit reached")
        }
    }

    socket.onerror = function (event) {
        console.log("error")
        console.log(event)
    }

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data["type"] === "pty_output") {
            terminal.write(data.output)
        }
    }

    function connection_button() {
        if (button.innerHTML === 'Connect') {
            location.reload();
        } else if (button.innerHTML === "Disconnect") {
            socket.close()
        }
    }

    function resize() {
        fitAddon.fit()
        socket.send(JSON.stringify({
            "type": "resize",
            "cols": terminal.cols,
            "rows": terminal.rows
        }));
    }

    function waitForSocketConnection(socket) {
        setTimeout(
            function () {
                if (socket.readyState === 1) {
                    console.log("Connection is made")
                    window.onresize = resize
                    window.onload = resize
                    resize()
                } else {
                    console.log("wait for connection...")
                    waitForSocketConnection(socket);
                }
            }, 1);
    }

    waitForSocketConnection(socket)

</script>

</body>
</html>
